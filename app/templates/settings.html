{% extends 'base.html' %}
{% block title %}Settings{% endblock %}
{% block content %}
<h2>Settings</h2>

<!-- Main Settings Tabs -->
<div class="settings-tabs" style="margin-bottom:1.5rem;">
  <button type="button" id="main-tab-display" class="tab-btn active">Display</button>
  <button type="button" id="main-tab-lighting" class="tab-btn">Lighting</button>
  <button type="button" id="main-tab-artwork" class="tab-btn">Artwork</button>
  <button type="button" id="main-tab-mqtt" class="tab-btn">MQTT</button>
  <button type="button" id="main-tab-logging" class="tab-btn">Logging</button>
</div>

<!-- Display Tab -->
<div id="display-tab-content">
  <h3>Display Settings</h3>
  <form method="post">
    <div class="settings-tabs" style="margin-bottom:1rem;">
      <button type="button" id="tab-basic" class="tab-btn">Basic</button>
      <button type="button" id="tab-advanced" class="tab-btn">Advanced</button>
    </div>

  <div id="basic-tab">
    <div>
      <label for="active">Active display plugin</label>
      <select id="active" name="active">
        <option value="ws2812" {% if display_cfg.active == 'ws2812' %}selected{% endif %}>WS2812 (legacy)</option>
        <option value="rgbmatrix" {% if display_cfg.active == 'rgbmatrix' %}selected{% endif %}>rpi-rgb-led-matrix</option>
      </select>
    </div>

    <hr>
    <div id="ws-section">
    <h3>WS2812 (legacy) configuration</h3>
    <div>
      <label for="ws_width">Width</label>
      <input id="ws_width" name="ws_width" type="number" value="{{ (display_cfg.plugins.ws2812.width if display_cfg.plugins is defined and display_cfg.plugins.ws2812 is defined and display_cfg.plugins.ws2812.width is defined else 16) }}">
    </div>
    <div>
      <label for="ws_height">Height</label>
      <input id="ws_height" name="ws_height" type="number" value="{{ (display_cfg.plugins.ws2812.height if display_cfg.plugins is defined and display_cfg.plugins.ws2812 is defined and display_cfg.plugins.ws2812.height is defined else 16) }}">
    </div>
    <div>
      <label for="ws_pin">GPIO Pin</label>
      <input id="ws_pin" name="ws_pin" type="number" value="{{ (display_cfg.plugins.ws2812.pin if display_cfg.plugins is defined and display_cfg.plugins.ws2812 is defined and display_cfg.plugins.ws2812.pin is defined else 18) }}">
      <small style="color:#666;">GPIO pin for data (default: 18)</small>
    </div>
    <div>
      <label for="ws_brightness">Initial Brightness</label>
      <input id="ws_brightness" name="ws_brightness" type="number" min="0" max="255" value="{{ (display_cfg.plugins.ws2812.brightness if display_cfg.plugins is defined and display_cfg.plugins.ws2812 is defined and display_cfg.plugins.ws2812.brightness is defined else 64) }}">
      <small style="color:#666;">0-255 (default: 64)</small>
    </div>
    <div>
      <label for="ws_freq_hz">Frequency (Hz)</label>
      <input id="ws_freq_hz" name="ws_freq_hz" type="number" value="{{ (display_cfg.plugins.ws2812.freq_hz if display_cfg.plugins is defined and display_cfg.plugins.ws2812 is defined and display_cfg.plugins.ws2812.freq_hz is defined else 800000) }}">
      <small style="color:#666;">Signal frequency (default: 800000)</small>
    </div>
    <div>
      <label for="ws_dma">DMA Channel</label>
      <input id="ws_dma" name="ws_dma" type="number" min="0" max="14" value="{{ (display_cfg.plugins.ws2812.dma if display_cfg.plugins is defined and display_cfg.plugins.ws2812 is defined and display_cfg.plugins.ws2812.dma is defined else 10) }}">
      <small style="color:#666;">DMA channel 0-14 (default: 10)</small>
    </div>
    <div>
      <label for="ws_channel">PWM Channel</label>
      <input id="ws_channel" name="ws_channel" type="number" min="0" max="1" value="{{ (display_cfg.plugins.ws2812.channel if display_cfg.plugins is defined and display_cfg.plugins.ws2812 is defined and display_cfg.plugins.ws2812.channel is defined else 0) }}">
      <small style="color:#666;">PWM channel 0 or 1 (default: 0)</small>
    </div>
    <div>
      <label for="ws_invert">Invert Signal</label>
      <input id="ws_invert" name="ws_invert" type="checkbox" value="1" {% if display_cfg.plugins is defined and display_cfg.plugins.ws2812 is defined and display_cfg.plugins.ws2812.invert %}checked{% endif %}>
      <small style="color:#666;">Invert the output signal</small>
    </div>
    <div>
      <label for="ws_serpentine">Serpentine Wiring</label>
      <input id="ws_serpentine" name="ws_serpentine" type="checkbox" value="1" {% if display_cfg.plugins is defined and display_cfg.plugins.ws2812 is defined and display_cfg.plugins.ws2812.serpentine %}checked{% endif %}>
      <small style="color:#666;">Alternate row direction (zigzag pattern)</small>
    </div>
    </div>

    <hr>
    <div id="rgb-section">
    <h3>rpi-rgb-led-matrix configuration</h3>
    <p style="font-size:0.9rem;color:#666">Fill only values relevant to your hardware; leave blank to use defaults.</p>
    <div>
      <label for="rgb_rows">Rows</label>
      <input id="rgb_rows" name="rgb_rows" type="number" value="{{ (display_cfg.plugins.rgbmatrix.rows if display_cfg.plugins is defined and display_cfg.plugins.rgbmatrix is defined and display_cfg.plugins.rgbmatrix.rows is defined else '') }}">
    </div>
    <div>
      <label for="rgb_cols">Cols</label>
      <input id="rgb_cols" name="rgb_cols" type="number" value="{{ (display_cfg.plugins.rgbmatrix.cols if display_cfg.plugins is defined and display_cfg.plugins.rgbmatrix is defined and display_cfg.plugins.rgbmatrix.cols is defined else '') }}">
    </div>
    <div>
      <label for="rgb_chain">Chain</label>
      <input id="rgb_chain" name="rgb_chain" type="number" value="{{ (display_cfg.plugins.rgbmatrix.chain if display_cfg.plugins is defined and display_cfg.plugins.rgbmatrix is defined and display_cfg.plugins.rgbmatrix.chain is defined else '') }}">
    </div>
    <div>
      <label for="rgb_parallel">Parallel</label>
      <input id="rgb_parallel" name="rgb_parallel" type="number" value="{{ (display_cfg.plugins.rgbmatrix.parallel if display_cfg.plugins is defined and display_cfg.plugins.rgbmatrix is defined and display_cfg.plugins.rgbmatrix.parallel is defined else '') }}">
    </div>
    <div>
      <label for="rgb_gpio_slowdown">gpio_slowdown</label>
      <input id="rgb_gpio_slowdown" name="rgb_gpio_slowdown" type="number" value="{{ (display_cfg.plugins.rgbmatrix.gpio_slowdown if display_cfg.plugins is defined and display_cfg.plugins.rgbmatrix is defined and display_cfg.plugins.rgbmatrix.gpio_slowdown is defined else '') }}">
    </div>

    </div>
    
    <p style="margin-top:1rem;font-size:0.9rem;color:#666">Note: The <strong>Basic</strong> tab is a convenience wrapper that exposes the most common plugin settings. If you need more control or want to edit additional options, switch to the <strong>Advanced</strong> tab to edit the raw plugin JSON.</p>

  </div>

  <div id="advanced-tab" style="display:none;">
    <h3>Advanced (raw JSON)</h3>
    <p style="font-size:0.9rem;color:#666">Edit plugin configuration as raw JSON. Top-level keys are plugin names. Example:
    <pre>{
  "ws2812": {"width":16,"height":16,"serpentine":false},
  "rgbmatrix": {"rows":64,"cols":64,"chain":1}
}</pre></p>
    <div>
      <label for="plugins_json">Plugin JSON</label>
      <textarea id="plugins_json" name="plugins_json" rows="12" style="width:100%;font-family:monospace;">{{ plugins_json }}</textarea>
    </div>
  </div>

  <div style="margin-top:1rem;">
    <button id="save-btn" type="submit">Save</button>
    <a href="{{ url_for('index') }}">Cancel</a>
  </div>
</form>
</div>

<!-- Lighting Tab -->
<div id="lighting-tab-content" style="display:none;">
  <h3>Nightlight Hardware Settings</h3>
  <p style="margin-bottom:1rem;color:#666;">
    Configure the WS2812B LED strip used for the nightlight feature.
  </p>
  
  <form method="post" action="{{ url_for('save_lighting_settings') }}">
    <div>
      <label for="nightlight_pin">GPIO Pin (BCM Numbering)</label>
      <input type="number" id="nightlight_pin" name="nightlight_pin" min="0" max="27" 
             value="{{ lighting_cfg.get('gpio_pin', 18) }}" required>
      <small style="color:#666;">GPIO pin for LED data line (e.g., 18, 12, 21). Uses BCM numbering.</small>
    </div>
    
    <div>
      <label for="nightlight_count">Number of LEDs</label>
      <input type="number" id="nightlight_count" name="nightlight_count" min="1" max="1000" 
             value="{{ lighting_cfg.get('led_count', 30) }}" required>
      <small style="color:#666;">Total number of LEDs in the strip (1-1000).</small>
    </div>
    
    <div style="background:#fef3c7;border:1px solid #fbbf24;border-radius:8px;padding:1rem;margin-top:1rem;">
      <p style="margin:0;color:#92400e;font-size:0.9rem;">
        ⚠️ <strong>Note:</strong> Changing these settings requires restarting the application to take effect.
      </p>
    </div>
    
    <div style="margin-top:1rem;">
      <button type="submit">Save Lighting Settings</button>
      <a href="{{ url_for('settings') }}">Cancel</a>
    </div>
  </form>
</div>

<!-- Artwork Tab -->
<div id="artwork-tab-content" style="display:none;">
  <h3>Artwork Cache</h3>
  <p style="margin-bottom:1rem;color:#666;">
    JellyJam caches album artwork locally to improve performance. You can clear the cache if you're experiencing issues or want to free up disk space.
  </p>
  
  <div style="background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:1.5rem;margin-bottom:1rem;">
    <h4 style="margin-top:0;margin-bottom:0.5rem;">Cache Information</h4>
    <p style="margin:0;color:#666;font-size:0.9rem;" id="artwork-info">Loading...</p>
  </div>
  
  <button type="button" id="clear-artwork-btn" class="btn-danger" style="background:#ef4444;color:white;padding:10px 20px;border:none;border-radius:6px;cursor:pointer;font-weight:500;">
    Clear Artwork Cache
  </button>
</div>

<!-- MQTT Tab -->
<div id="mqtt-tab-content" style="display:none;">
  <h3>MQTT Settings</h3>
  <p style="margin-bottom:1rem;color:#666;">
    Configure MQTT integration for connecting to Home Assistant and other MQTT-compatible systems.
  </p>
  
  <form method="post" action="{{ url_for('save_mqtt_settings') }}">
    <div>
      <label for="mqtt_enabled">Enable MQTT</label>
      <input type="checkbox" id="mqtt_enabled" name="mqtt_enabled" value="1" {% if mqtt_cfg.get('enabled') %}checked{% endif %}>
    </div>
    
    <div>
      <label for="mqtt_broker">MQTT Broker Address</label>
      <input type="text" id="mqtt_broker" name="mqtt_broker" placeholder="localhost" value="{{ mqtt_cfg.get('broker', '') }}">
      <small style="color:#666;">Hostname or IP address (e.g., homeassistant.local or 192.168.1.100)</small>
    </div>
    
    <div>
      <label for="mqtt_port">Port</label>
      <input type="number" id="mqtt_port" name="mqtt_port" placeholder="1883" value="{{ mqtt_cfg.get('port', 1883) }}">
    </div>
    
    <div>
      <label for="mqtt_username">Username (optional)</label>
      <input type="text" id="mqtt_username" name="mqtt_username" value="{{ mqtt_cfg.get('username', '') }}">
    </div>
    
    <div>
      <label for="mqtt_password">Password (optional)</label>
      <input type="password" id="mqtt_password" name="mqtt_password" value="{{ mqtt_cfg.get('password', '') }}">
    </div>
    
    <div>
      <label for="mqtt_topic">Topic Prefix</label>
      <input type="text" id="mqtt_topic" name="mqtt_topic" placeholder="jellyjam" value="{{ mqtt_cfg.get('topic', 'jellyjam') }}">
      <small style="color:#666;">Base topic for MQTT messages (e.g., jellyjam/light)</small>
    </div>
    
    <div>
      <label for="mqtt_discovery">Enable Home Assistant Discovery</label>
      <input type="checkbox" id="mqtt_discovery" name="mqtt_discovery" value="1" {% if mqtt_cfg.get('discovery', True) %}checked{% endif %}>
      <small style="color:#666;">Automatically register with Home Assistant</small>
    </div>
    
    <div style="margin-top:1rem;">
      <button type="submit">Save MQTT Settings</button>
      <a href="{{ url_for('settings') }}">Cancel</a>
    </div>
  </form>
</div>

<!-- Logging Tab -->
<div id="logging-tab-content" style="display:none;">
  <h3>Logging Settings</h3>
  <p style="margin-bottom:1rem;color:#666;">
    Configure application logging level and view recent log entries.
  </p>
  
  <form method="post" action="{{ url_for('save_logging_settings') }}">
    <div>
      <label for="log_level">Log Level</label>
      <select id="log_level" name="log_level">
        <option value="DEBUG" {% if logging_cfg.get('log_level', 'INFO') == 'DEBUG' %}selected{% endif %}>DEBUG (most verbose)</option>
        <option value="INFO" {% if logging_cfg.get('log_level', 'INFO') == 'INFO' %}selected{% endif %}>INFO (normal)</option>
        <option value="WARNING" {% if logging_cfg.get('log_level', 'INFO') == 'WARNING' %}selected{% endif %}>WARNING</option>
        <option value="ERROR" {% if logging_cfg.get('log_level', 'INFO') == 'ERROR' %}selected{% endif %}>ERROR</option>
        <option value="CRITICAL" {% if logging_cfg.get('log_level', 'INFO') == 'CRITICAL' %}selected{% endif %}>CRITICAL (least verbose)</option>
      </select>
      <small style="color:#666;">Minimum log level to record. Restart required for changes to take full effect.</small>
    </div>
    
    <div>
      <label for="display_lines">Display Lines</label>
      <input type="number" id="display_lines" name="display_lines" min="10" max="10000" value="{{ logging_cfg.get('display_lines', 100) }}">
      <small style="color:#666;">Number of recent log lines to display (10-10000)</small>
    </div>
    
    <div>
      <label for="buffer_capacity">Buffer Capacity</label>
      <input type="number" id="buffer_capacity" name="buffer_capacity" min="100" max="100000" value="{{ logging_cfg.get('buffer_capacity', 1000) }}">
      <small style="color:#666;">Maximum log entries to keep in memory (100-100000)</small>
    </div>
    
    <hr style="margin:1.5rem 0;border:none;border-top:1px solid #ddd;">
    
    <h4 style="margin-bottom:0.5rem;">File Logging</h4>
    <p style="margin-bottom:1rem;color:#666;font-size:0.9rem;">
      Optionally write logs to rotating files in data/logs directory.
    </p>
    
    <div>
      <label for="enable_file_logging">
        <input type="checkbox" id="enable_file_logging" name="enable_file_logging" 
               {% if logging_cfg.get('enable_file_logging', False) %}checked{% endif %}>
        Enable File Logging
      </label>
      <small style="color:#666;display:block;margin-top:0.25rem;">Write all log entries to files on disk</small>
    </div>
    
    <div>
      <label for="max_log_files">Maximum Log Files</label>
      <input type="number" id="max_log_files" name="max_log_files" min="1" max="100" value="{{ logging_cfg.get('max_log_files', 5) }}">
      <small style="color:#666;">Number of rotating log files to keep (1-100, default: 5)</small>
    </div>
    
    <div>
      <label for="max_log_size_mb">Max File Size (MB)</label>
      <input type="number" id="max_log_size_mb" name="max_log_size_mb" min="1" max="1000" value="{{ logging_cfg.get('max_log_size_mb', 10) }}">
      <small style="color:#666;">Maximum size per log file before rotation (1-1000 MB, default: 10)</small>
    </div>
    
    <div style="margin-top:1rem;">
      <button type="submit">Save Logging Settings</button>
      <a href="{{ url_for('settings') }}">Cancel</a>
    </div>
  </form>
  
  <hr style="margin:2rem 0;">
  
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
    <h3 style="margin:0;">Live Log Viewer</h3>
    <div>
      <label style="margin-right:1rem;">
        <input type="checkbox" id="auto-scroll" checked> Auto-scroll
      </label>
      <label style="margin-right:1rem;">
        Filter:
        <select id="log-filter-level">
          <option value="0">ALL</option>
          <option value="10">DEBUG+</option>
          <option value="20" selected>INFO+</option>
          <option value="30">WARNING+</option>
          <option value="40">ERROR+</option>
        </select>
      </label>
      <button type="button" id="refresh-logs" style="padding:0.3rem 0.8rem;">Refresh</button>
      <button type="button" id="clear-logs" style="padding:0.3rem 0.8rem;background:#dc3545;">Clear</button>
    </div>
  </div>
  
  <div id="log-viewer" style="background:#1a1a1a;color:#d0d0d0;font-family:monospace;font-size:0.85rem;padding:1rem;height:500px;overflow-y:auto;border-radius:4px;white-space:pre-wrap;word-wrap:break-word;">
    <div style="color:#888;text-align:center;padding:2rem;">Loading logs...</div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  // Main tab switching (Display vs Lighting vs Artwork vs MQTT vs Logging)
  const mainTabDisplay = document.getElementById('main-tab-display');
  const mainTabLighting = document.getElementById('main-tab-lighting');
  const mainTabArtwork = document.getElementById('main-tab-artwork');
  const mainTabMqtt = document.getElementById('main-tab-mqtt');
  const mainTabLogging = document.getElementById('main-tab-logging');
  const displayTabContent = document.getElementById('display-tab-content');
  const lightingTabContent = document.getElementById('lighting-tab-content');
  const artworkTabContent = document.getElementById('artwork-tab-content');
  const mqttTabContent = document.getElementById('mqtt-tab-content');
  const loggingTabContent = document.getElementById('logging-tab-content');
  
  function showMainTab(tab) {
    // Hide all tabs
    displayTabContent.style.display = 'none';
    lightingTabContent.style.display = 'none';
    artworkTabContent.style.display = 'none';
    mqttTabContent.style.display = 'none';
    loggingTabContent.style.display = 'none';
    mainTabDisplay.classList.remove('active');
    mainTabLighting.classList.remove('active');
    mainTabArtwork.classList.remove('active');
    mainTabMqtt.classList.remove('active');
    mainTabLogging.classList.remove('active');
    
    // Show selected tab
    if (tab === 'lighting') {
      lightingTabContent.style.display = '';
      mainTabLighting.classList.add('active');
    } else if (tab === 'artwork') {
      artworkTabContent.style.display = '';
      mainTabArtwork.classList.add('active');
      loadArtworkInfo();
    } else if (tab === 'mqtt') {
      mqttTabContent.style.display = '';
      mainTabMqtt.classList.add('active');
    } else if (tab === 'logging') {
      loggingTabContent.style.display = '';
      mainTabLogging.classList.add('active');
      startLogViewer();
    } else {
      displayTabContent.style.display = '';
      mainTabDisplay.classList.add('active');
    }
  }
  
  mainTabDisplay.addEventListener('click', () => showMainTab('display'));
  mainTabLighting.addEventListener('click', () => showMainTab('lighting'));
  mainTabArtwork.addEventListener('click', () => showMainTab('artwork'));
  mainTabMqtt.addEventListener('click', () => showMainTab('mqtt'));
  mainTabLogging.addEventListener('click', () => showMainTab('logging'));
  
  // Load artwork cache info
  function loadArtworkInfo() {
    fetch('/api/artwork/info')
      .then(r => r.json())
      .then(data => {
        const info = document.getElementById('artwork-info');
        if (data.error) {
          info.textContent = 'Error loading cache info';
        } else {
          const size = data.total_size_mb ? data.total_size_mb.toFixed(2) + ' MB' : '0 MB';
          info.textContent = `${data.file_count || 0} files • ${size}`;
        }
      })
      .catch(e => {
        document.getElementById('artwork-info').textContent = 'Error loading cache info';
      });
  }
  
  // Clear artwork cache
  document.getElementById('clear-artwork-btn').addEventListener('click', function() {
    if (!confirm('Are you sure you want to clear the artwork cache? This will delete all cached album artwork and cannot be undone.')) {
      return;
    }
    
    const btn = this;
    btn.disabled = true;
    btn.textContent = 'Clearing...';
    
    fetch('/api/artwork/clear', { method: 'POST' })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          showToast('Artwork cache cleared successfully', 3000);
          loadArtworkInfo();
        } else {
          showToast('Error clearing cache: ' + (data.error || 'Unknown error'), 5000);
        }
      })
      .catch(e => {
        showToast('Error clearing cache', 5000);
      })
      .finally(() => {
        btn.disabled = false;
        btn.textContent = 'Clear Artwork Cache';
      });
  });

  // Display settings tab switching (Basic vs Advanced)
  const select = document.getElementById('active');
  const wsSectionEl = document.getElementById('ws-section');
  const rgbSectionEl = document.getElementById('rgb-section');

  function updateVisibility(){
    const active = select.value;
    if(active === 'ws2812'){
      wsSectionEl.style.display = '';
      rgbSectionEl.style.display = 'none';
    } else if(active === 'rgbmatrix'){
      wsSectionEl.style.display = 'none';
      rgbSectionEl.style.display = '';
    } else {
      wsSectionEl.style.display = '';
      rgbSectionEl.style.display = '';
    }
  }

  select.addEventListener('change', updateVisibility);
  updateVisibility();

  // Tab switching
  const tabBasic = document.getElementById('tab-basic');
  const tabAdvanced = document.getElementById('tab-advanced');
  const basicTab = document.getElementById('basic-tab');
  const advancedTab = document.getElementById('advanced-tab');
  function showTab(name){
    if(name === 'advanced'){
      basicTab.style.display = 'none'; advancedTab.style.display = '';
      tabBasic.classList.remove('active'); tabAdvanced.classList.add('active');
    } else {
      basicTab.style.display = ''; advancedTab.style.display = 'none';
      tabBasic.classList.add('active'); tabAdvanced.classList.remove('active');
    }
  }
  tabBasic.addEventListener('click', ()=> showTab('basic'));
  tabAdvanced.addEventListener('click', ()=> showTab('advanced'));
  // default to basic
  showTab('basic');

  const form = select.closest('form');
  form.addEventListener('submit', function(e){
    const active = select.value;
    const saveBtn = document.getElementById('save-btn');
    function invalid(msg){
      e.preventDefault();
      try{ showToast(msg, 3000); }catch(e){ alert(msg); }
      return false;
    }
    if(active === 'ws2812'){
      const w = document.getElementById('ws_width').value.trim();
      const h = document.getElementById('ws_height').value.trim();
      if(w){ const wi = parseInt(w,10); if(isNaN(wi) || wi < 1 || wi > 512) return invalid('WS2812 width must be 1-512'); }
      if(h){ const hi = parseInt(h,10); if(isNaN(hi) || hi < 1 || hi > 512) return invalid('WS2812 height must be 1-512'); }
    }
    if(active === 'rgbmatrix'){
      const rows = document.getElementById('rgb_rows').value.trim();
      const cols = document.getElementById('rgb_cols').value.trim();
      const chain = document.getElementById('rgb_chain').value.trim();
      const parallel = document.getElementById('rgb_parallel').value.trim();
      const gpio = document.getElementById('rgb_gpio_slowdown').value.trim();
      if(rows){ const r = parseInt(rows,10); if(isNaN(r) || r < 8 || r > 2048) return invalid('Rows must be 8-2048'); }
      if(cols){ const c = parseInt(cols,10); if(isNaN(c) || c < 8 || c > 2048) return invalid('Cols must be 8-2048'); }
      if(chain){ const v = parseInt(chain,10); if(isNaN(v) || v < 1 || v > 64) return invalid('Chain must be 1-64'); }
      if(parallel){ const v = parseInt(parallel,10); if(isNaN(v) || v < 1 || v > 64) return invalid('Parallel must be 1-64'); }
      if(gpio){ const v = parseInt(gpio,10); if(isNaN(v) || v < 0 || v > 100) return invalid('gpio_slowdown must be 0-100'); }
    }
    saveBtn.disabled = true;
    setTimeout(()=>{ saveBtn.disabled = false; }, 3000);
  });
  
  // ===== Logging Tab - Live Log Viewer =====
  let logViewerInterval = null;
  let lastLogCount = 0;
  
  function formatLogEntry(entry) {
    const levelColors = {
      'DEBUG': '#888',
      'INFO': '#5bc0de',
      'WARNING': '#f0ad4e',
      'ERROR': '#d9534f',
      'CRITICAL': '#ff0000'
    };
    const color = levelColors[entry.level] || '#d0d0d0';
    const timestamp = new Date(entry.timestamp * 1000).toLocaleTimeString();
    return `<span style="color:#666;">${timestamp}</span> <span style="color:${color};font-weight:bold;">${entry.level.padEnd(8)}</span> <span style="color:#aaa;">${entry.name}</span> - ${escapeHtml(entry.message)}`;
  }
  
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  function loadLogs() {
    const displayLines = parseInt(document.getElementById('display_lines').value) || 100;
    const filterLevel = parseInt(document.getElementById('log-filter-level').value) || 0;
    const levelNames = {0: 'DEBUG', 10: 'DEBUG', 20: 'INFO', 30: 'WARNING', 40: 'ERROR'};
    const levelName = levelNames[filterLevel] || 'DEBUG';
    
    fetch(`/api/logs?n=${displayLines}&level=${levelName}`)
      .then(r => r.json())
      .then(data => {
        const viewer = document.getElementById('log-viewer');
        const autoScroll = document.getElementById('auto-scroll').checked;
        const wasScrolledToBottom = viewer.scrollHeight - viewer.clientHeight <= viewer.scrollTop + 1;
        
        if (data.logs && data.logs.length > 0) {
          const html = data.logs.map(formatLogEntry).join('\n');
          viewer.innerHTML = html;
          lastLogCount = data.logs.length;
          
          // Auto-scroll to bottom if enabled and was already at bottom
          if (autoScroll && (wasScrolledToBottom || lastLogCount === 0)) {
            viewer.scrollTop = viewer.scrollHeight;
          }
        } else {
          viewer.innerHTML = '<div style="color:#888;text-align:center;padding:2rem;">No log entries</div>';
          lastLogCount = 0;
        }
      })
      .catch(err => {
        console.error('Error loading logs:', err);
        document.getElementById('log-viewer').innerHTML = `<div style="color:#d9534f;text-align:center;padding:2rem;">Error loading logs: ${err.message}</div>`;
      });
  }
  
  function startLogViewer() {
    // Load logs immediately
    loadLogs();
    
    // Set up auto-refresh every 2 seconds
    if (logViewerInterval) {
      clearInterval(logViewerInterval);
    }
    logViewerInterval = setInterval(loadLogs, 2000);
  }
  
  function stopLogViewer() {
    if (logViewerInterval) {
      clearInterval(logViewerInterval);
      logViewerInterval = null;
    }
  }
  
  // Logging tab event handlers
  if (document.getElementById('refresh-logs')) {
    document.getElementById('refresh-logs').addEventListener('click', loadLogs);
  }
  
  if (document.getElementById('clear-logs')) {
    document.getElementById('clear-logs').addEventListener('click', function() {
      if (confirm('Clear all log entries from memory? This cannot be undone.')) {
        // TODO: Add API endpoint to clear logs
        showToast('Log clearing not yet implemented', 2000);
      }
    });
  }
  
  if (document.getElementById('log-filter-level')) {
    document.getElementById('log-filter-level').addEventListener('change', loadLogs);
  }
  
  // Stop log viewer when leaving the page
  window.addEventListener('beforeunload', stopLogViewer);
});
</script>
{% if saved %}
<script>document.addEventListener('DOMContentLoaded', function(){ showToast('Settings saved', 2500); });</script>
{% endif %}
{% if error %}
<script>document.addEventListener('DOMContentLoaded', function(){ try{ showToast('{{ error|e }}'); }catch(e){ alert('{{ error|e }}'); } var cont=document.getElementById('toast'); if(cont && cont.lastElementChild){ cont.lastElementChild.classList.add('error'); } });</script>
{% endif %}
{% endblock %}
