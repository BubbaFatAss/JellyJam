{% extends 'base.html' %}
{% block content %}
  <section class="panel">
    <h2>Simulate NFC Scan</h2>
    <label>Card
      <select id="card-select" onchange="updateSimulateCardId()">
        <option value="">-- Select a registered card --</option>
        {% for card_id, friendly_name in nfc_cards.items() %}
          <option value="{{ card_id }}">{{ friendly_name }} ({{ card_id }})</option>
        {% endfor %}
        <option value="__manual__">‚å®Ô∏è Enter Card ID Manually</option>
      </select>
    </label>
    <div id="manual-card-wrapper" style="margin-top:0.5rem;">
      <label>Card ID <input id="card" placeholder="card id"></label>
    </div>
    <div class="form-actions"><button id="sim">Simulate</button></div>
  </section>

  <section class="panel">
    <h2>Mappings</h2>
    <div id="quick-mappings">
      <label for="mapping-select">Choose mapping:</label>
      <select id="mapping-select" style="min-width:220px">
        <option value="">Loading mappings...</option>
      </select>
      <button id="mapping-play" style="margin-left:.5rem">Play</button>
    </div>
  </section>

  <script>
  function updateSimulateCardId() {
    const select = document.getElementById('card-select');
    const cardInput = document.getElementById('card');
    
    if (select.value && select.value !== '__manual__') {
      cardInput.value = select.value;
    } else if (select.value !== '__manual__') {
      cardInput.value = '';
    }
  }
  
  document.getElementById('sim').addEventListener('click', async () => {
    const card = document.getElementById('card').value;
    if (!card) {
      if (typeof showToast === 'function') {
        showToast('Please enter or select a card ID', 2500);
      } else {
        alert('Please enter or select a card ID');
      }
      return;
    }
    
    try {
      const res = await fetch('/simulate', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({card_id: card})});
      const j = await res.json();
      
      if (j.ok) {
        if (typeof showToast === 'function') {
          showToast(`‚úì Simulated card scan: ${card}`, 2500);
        } else {
          alert('Simulated successfully');
        }
      } else {
        if (typeof showToast === 'function') {
          showToast(`Error: ${j.error || 'Simulation failed'}`, 3000);
        } else {
          alert(`Error: ${j.error || 'Simulation failed'}`);
        }
      }
    } catch (err) {
      console.error('Simulation error:', err);
      if (typeof showToast === 'function') {
        showToast('Network error during simulation', 3000);
      } else {
        alert('Network error during simulation');
      }
    }
  });

  async function loadQuickMappings(){
    try{
      const r = await fetch('/api/mappings');
      if(!r.ok) return;
      const j = await r.json();
      const select = document.getElementById('mapping-select');
      select.innerHTML = '';
      const maps = j.mappings || [];
      if(maps.length === 0){
        select.appendChild(new Option('No mappings configured', ''));
        document.getElementById('mapping-play').disabled = true;
        return;
      }
      select.appendChild(new Option('-- select a mapping --', ''));
      for(const m of maps){
        const playlistName = (m.name && m.name.length>0)? m.name : (m.id || 'Unknown');
        const typeLabel = m.type === 'spotify' ? 'üéµ Spotify' : 'üíø Local';
        // Show friendly name if available, otherwise card ID
        const cardLabel = m.card_friendly_name ? `${m.card_friendly_name} (${m.card_id})` : m.card_id;
        const label = `[${cardLabel}] ${typeLabel}: ${playlistName}`;
        select.appendChild(new Option(label, m.card_id));
      }
      document.getElementById('mapping-play').disabled = false;
    }catch(e){ console.error('Failed to load mappings', e); }
  }
  loadQuickMappings();

  document.getElementById('mapping-play').addEventListener('click', async ()=>{
    const sel = document.getElementById('mapping-select');
    const card = sel.value;
    if(!card){ return alert('Please select a mapping to play'); }
    try{
      const resp = await fetch('/simulate', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({card_id: card})});
      if(!resp.ok){ const j = await resp.json().catch(()=>({})); return alert('Failed to trigger mapping: '+(j.error||resp.status)); }
      showToast('Mapping triggered');
    }catch(e){ showToast('Failed to trigger mapping'); }
  });
  </script>
{% endblock %}
