{% extends 'base.html' %}
{% block content %}
  <section class="panel">
    <h2>Audiobooks</h2>
    <p>Download and convert Audible audiobooks to M4B format. Configure authentication in <a href="{{ url_for('settings') }}#audible" style="color:#0288d1;text-decoration:underline;">Settings → Audible</a>.</p>

    <!-- Library Browser -->
    <div id="library-section" style="margin-bottom:2rem;">
      <h3>Your Audible Library</h3>
      <div id="auth-message" style="display:none;padding:1rem;background:#fff3cd;border-left:4px solid #ffc107;margin-bottom:1rem;">
        <strong>⚠ Not authenticated</strong>
        <p style="margin:0.5rem 0 0 0;">Please <a href="{{ url_for('settings') }}#audible" style="color:#0288d1;text-decoration:underline;">sign in to Audible</a> to view your library.</p>
      </div>
      <button id="refresh-library" style="margin-bottom:1rem;">Refresh Library</button>
      
      <div id="library-list" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:1rem;"></div>
      
      <div id="library-pagination" style="margin-top:1rem;display:flex;gap:0.5rem;align-items:center;">
        <button id="prev-page">Previous</button>
        <span id="page-info">Page 1</span>
        <button id="next-page">Next</button>
      </div>
    </div>

    <!-- Conversion Jobs -->
    <div id="jobs-section" style="margin-bottom:2rem;">
      <h3>Conversion Jobs</h3>
      <button id="refresh-jobs" style="margin-bottom:1rem;">Refresh Jobs</button>
      <div id="jobs-list"></div>
    </div>
  </section>

  <style>
    .book-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .book-card img {
      width: 100%;
      height: auto;
      border-radius: 4px;
    }
    .book-card h4 {
      margin: 0;
      font-size: 1rem;
    }
    .book-card .authors {
      font-size: 0.9rem;
      color: #666;
    }
    .book-card .runtime {
      font-size: 0.85rem;
      color: #999;
    }
    .book-card button {
      margin-top: 0.5rem;
    }
    .job-item {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
    }
    .job-item .job-status {
      font-weight: bold;
    }
    .job-item .job-status.pending { color: #999; }
    .job-item .job-status.running { color: #1f8ceb; }
    .job-item .job-status.completed { color: #28a745; }
    .job-item .job-status.failed { color: #dc3545; }
    .job-item .progress-bar {
      width: 100%;
      height: 20px;
      background: #f0f0f0;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 0.5rem;
    }
    .job-item .progress-bar-fill {
      height: 100%;
      background: #1f8ceb;
      transition: width 0.3s;
    }
  </style>

  <script>
    let currentPage = 1;
    let totalPages = 1;
    let isAuthenticated = false;

    async function checkAuthStatus() {
      try {
        const r = await fetch('/api/audible/auth/status');
        const j = await r.json();
        isAuthenticated = j.authenticated || false;
        
        if (isAuthenticated) {
          document.getElementById('auth-message').style.display = 'none';
          loadLibrary();
        } else {
          document.getElementById('auth-message').style.display = 'block';
          document.getElementById('library-list').innerHTML = '';
        }
      } catch(e) {
        console.error('Error checking auth status:', e);
        document.getElementById('auth-message').style.display = 'block';
      }
    }

    async function loadLibrary(page = 1) {
      if (!isAuthenticated) {
        document.getElementById('auth-message').style.display = 'block';
        return;
      }
      
      try {
        const r = await fetch(`/api/audible/library?page=${page}&num_results=20`);
        const j = await r.json();
        
        if (j.error) {
          showToast('Failed to load library: ' + j.error, 5000);
          return;
        }
        
        const items = j.items || [];
        const total = j.total || 0;
        currentPage = j.page || page;
        totalPages = Math.ceil(total / 20);
        
        const listEl = document.getElementById('library-list');
        listEl.innerHTML = '';
        
        items.forEach(book => {
          const card = document.createElement('div');
          card.className = 'book-card';
          
          const img = document.createElement('img');
          img.src = book.cover_url || '/static/placeholder_artwork.svg';
          img.alt = book.title;
          
          const title = document.createElement('h4');
          title.innerText = book.title || 'Unknown Title';
          
          const authors = document.createElement('div');
          authors.className = 'authors';
          authors.innerText = (book.authors || []).join(', ') || 'Unknown Author';
          
          const runtime = document.createElement('div');
          runtime.className = 'runtime';
          const hours = Math.floor((book.runtime_minutes || 0) / 60);
          const minutes = (book.runtime_minutes || 0) % 60;
          runtime.innerText = `${hours}h ${minutes}m`;
          
          const downloadBtn = document.createElement('button');
          downloadBtn.innerText = 'Download & Convert';
          downloadBtn.addEventListener('click', async () => {
            try {
              showToast('Starting download for ' + book.title + '...');
              const dr = await fetch('/api/audible/download', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({asin: book.asin, auto_convert: true})
              });
              const dj = await dr.json();
              
              if (dj.success) {
                showToast('Download started! Conversion job ID: ' + dj.job_id);
                loadJobs();
              } else {
                showToast('Download failed: ' + (dj.error || 'Unknown error'), 5000);
              }
            } catch(e) {
              showToast('Download failed: ' + e.message, 5000);
            }
          });
          
          card.appendChild(img);
          card.appendChild(title);
          card.appendChild(authors);
          card.appendChild(runtime);
          card.appendChild(downloadBtn);
          
          listEl.appendChild(card);
        });
        
        document.getElementById('page-info').innerText = `Page ${currentPage} of ${totalPages}`;
        document.getElementById('prev-page').disabled = currentPage <= 1;
        document.getElementById('next-page').disabled = currentPage >= totalPages;
      } catch(e) {
        showToast('Failed to load library: ' + e.message, 5000);
      }
    }

    document.getElementById('refresh-library').addEventListener('click', () => loadLibrary(currentPage));
    document.getElementById('prev-page').addEventListener('click', () => loadLibrary(currentPage - 1));
    document.getElementById('next-page').addEventListener('click', () => loadLibrary(currentPage + 1));

    async function loadJobs() {
      try {
        const r = await fetch('/api/audible/jobs');
        const j = await r.json();
        
        if (j.error) {
          return;
        }
        
        const jobs = j.jobs || [];
        const listEl = document.getElementById('jobs-list');
        listEl.innerHTML = '';
        
        if (jobs.length === 0) {
          listEl.innerHTML = '<p style="color:#999;">No conversion jobs</p>';
          return;
        }
        
        jobs.forEach(job => {
          const item = document.createElement('div');
          item.className = 'job-item';
          
          const status = document.createElement('div');
          status.className = 'job-status ' + job.status;
          status.innerText = 'Status: ' + job.status.toUpperCase();
          
          const input = document.createElement('div');
          input.style.fontSize = '0.9rem';
          input.innerText = 'Input: ' + job.input_path;
          
          const progress = document.createElement('div');
          progress.className = 'progress-bar';
          const progressFill = document.createElement('div');
          progressFill.className = 'progress-bar-fill';
          progressFill.style.width = (job.progress || 0) + '%';
          progress.appendChild(progressFill);
          
          item.appendChild(status);
          item.appendChild(input);
          
          if (job.status === 'running' || job.status === 'pending') {
            item.appendChild(progress);
          }
          
          if (job.status === 'completed' && job.output_file) {
            const output = document.createElement('div');
            output.style.fontSize = '0.9rem';
            output.style.color = '#28a745';
            output.innerText = '✓ Output: ' + job.output_file;
            item.appendChild(output);
          }
          
          if (job.status === 'failed' && job.error) {
            const error = document.createElement('div');
            error.style.fontSize = '0.9rem';
            error.style.color = '#dc3545';
            error.innerText = '✗ Error: ' + job.error;
            item.appendChild(error);
          }
          
          listEl.appendChild(item);
        });
      } catch(e) {
        console.error('Failed to load jobs:', e);
      }
    }

    document.getElementById('refresh-jobs').addEventListener('click', loadJobs);

    // Auto-refresh jobs every 5 seconds (fallback if Socket.IO not available)
    let pollInterval = setInterval(loadJobs, 5000);

    // Initialize
    checkAuthStatus();
    loadJobs();

    // Setup Socket.IO for real-time conversion updates
    (async function() {
      try {
        const ok = await setupSocketIO();
        
        if (ok && window.jellyJamSocket) {
          const socket = window.jellyJamSocket;
          
          socket.on('connect', () => {
            console.log('Socket.IO connected - subscribing to audiobook jobs');
            // Stop polling since we have real-time updates
            clearInterval(pollInterval);
            // Subscribe to job updates
            socket.emit('subscribe_audible_jobs');
          });
          
          socket.on('disconnect', () => {
            console.log('Socket.IO disconnected - falling back to polling');
            // Resume polling if disconnected
            pollInterval = setInterval(loadJobs, 5000);
          });
          
          // Listen for job list updates
          socket.on('audible_jobs_update', (data) => {
            if (data.error) {
              console.error('Jobs update error:', data.error);
              return;
            }
            
            const jobs = data.jobs || [];
            const listEl = document.getElementById('jobs-list');
            listEl.innerHTML = '';
            
            if (jobs.length === 0) {
              listEl.innerHTML = '<p style="color:#999;">No conversion jobs</p>';
              return;
            }
            
            jobs.forEach(job => {
              const item = document.createElement('div');
              item.className = 'job-item';
              
              const status = document.createElement('div');
              status.className = 'job-status ' + job.status;
              status.innerText = 'Status: ' + job.status.toUpperCase();
              
              const input = document.createElement('div');
              input.style.fontSize = '0.9rem';
              input.innerText = 'Input: ' + job.input_path;
              
              const progress = document.createElement('div');
              progress.className = 'progress-bar';
              const progressFill = document.createElement('div');
              progressFill.className = 'progress-bar-fill';
              progressFill.style.width = (job.progress || 0) + '%';
              progress.appendChild(progressFill);
              
              item.appendChild(status);
              item.appendChild(input);
              
              if (job.status === 'running' || job.status === 'pending') {
                item.appendChild(progress);
              }
              
              if (job.status === 'completed' && job.output_file) {
                const output = document.createElement('div');
                output.style.fontSize = '0.9rem';
                output.style.color = '#28a745';
                output.innerText = '✓ Output: ' + job.output_file;
                item.appendChild(output);
              }
              
              if (job.status === 'failed' && job.error) {
                const error = document.createElement('div');
                error.style.fontSize = '0.9rem';
                error.style.color = '#dc3545';
                error.innerText = '✗ Error: ' + job.error;
                item.appendChild(error);
              }
              
              listEl.appendChild(item);
            });
          });
          
          socket.on('conversion_complete', (data) => {
            console.log('Conversion complete:', data);
            
            // Show toast notification
            if (data.status === 'completed') {
              showToast('✓ Conversion completed successfully!', 5000);
            } else if (data.status === 'failed') {
              const errorMsg = data.error || 'Unknown error';
              showToast('✗ Conversion failed: ' + errorMsg, 7000);
            }
          });
        }
      } catch(e) {
        console.warn('Socket.IO setup failed, falling back to polling:', e);
      }
    })();
  </script>
{% endblock %}
