{% extends 'base.html' %}
{% block content %}
  <section class="panel">
    <h2>Now Playing</h2>
    <div id="np">
      <div style="display:flex;gap:1rem;align-items:center">
        <img id="album-art" src="" alt="album art" style="width:120px;height:120px;object-fit:cover;border-radius:8px">
        <div>
          <div><strong id="title">-</strong></div>
          <div id="artist">-</div>
          <div id="album">-</div>
        </div>
      </div>
      <div style="margin-top:1rem">
        <button id="prev">⏮</button>
        <button id="playpause">⏯</button>
  <button id="stop" style="margin-left:.5rem;">⏹</button>
        <button id="next">⏭</button>
      </div>
      <div style="margin-top:1rem">
        <input id="seek" type="range" min="0" max="100" value="0" style="width:100%">
        <div><span id="pos">0:00</span> / <span id="dur">0:00</span></div>
      </div>
      <div style="margin-top:1rem">
        <label for="volume">Volume</label>
        <input id="volume" type="range" min="0" max="100" value="50" style="width:100%">
      </div>
      <div style="margin-top:1rem;display:flex;gap:.5rem;align-items:center">
        <button id="shuffle-btn" title="Toggle shuffle" class="icon-btn"><svg><use xlink:href="#icon-shuffle"></use></svg></button>
        <button id="repeat-btn" title="Toggle repeat" class="icon-btn"><svg><use xlink:href="#icon-repeat"></use></svg></button>
      </div>
    </div>
  </section>

  <section class="panel">
    <h2>Mappings</h2>
    <div id="quick-mappings">
      <label for="mapping-select">Choose mapping:</label>
      <select id="mapping-select" style="min-width:220px">
        <option value="">Loading mappings...</option>
      </select>
      <button id="mapping-play" style="margin-left:.5rem">Play</button>
    </div>
  </section>

  <script>
  // Now Playing logic (moved from now_playing.html)
  let polling = null;
  async function fetchNow(){
    const r = await fetch('/api/nowplaying');
    const j = await r.json();
    function valOrDash(v){ return (v === null || v === undefined || v === '' || v === -1)? '-' : v; }
    document.getElementById('title').innerText = valOrDash(j.title);
    document.getElementById('artist').innerText = valOrDash(j.artist);
    document.getElementById('album').innerText = valOrDash(j.album);
    const posRaw = j.position_ms;
    const durRaw = j.duration_ms;
    // Show dashes when values are missing or invalid (for stopped playback some backends return -1)
    if (typeof posRaw === 'number' && typeof durRaw === 'number' && durRaw > 0 && posRaw >= 0){
      document.getElementById('pos').innerText = msToTime(posRaw);
      document.getElementById('dur').innerText = msToTime(durRaw);
      const pct = Math.floor((posRaw/durRaw)*100);
      document.getElementById('seek').value = pct;
      document.getElementById('seek').disabled = false;
    } else {
      document.getElementById('pos').innerText = '-';
      document.getElementById('dur').innerText = '-';
      document.getElementById('seek').value = 0;
      document.getElementById('seek').disabled = true;
    }
  const img = (j.image_url === null || j.image_url === undefined || j.image_url === -1)? '' : j.image_url || '';
  document.getElementById('album-art').src = img || '/static/placeholder_artwork.svg';
    document.getElementById('playpause').innerText = j.playing? '⏸':'⏯';
  }
  function msToTime(ms){
    const s = Math.floor(ms/1000); const m = Math.floor(s/60); const sec = s%60; return `${m}:${sec.toString().padStart(2,'0')}`;
  }
  document.getElementById('playpause').addEventListener('click', async ()=>{
    const action = document.getElementById('playpause').innerText==='⏯'?'play':'pause';
    await fetch('/api/control',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action})});
    setTimeout(fetchNow,300);
  });
  document.getElementById('next').addEventListener('click', async ()=>{ await fetch('/api/control',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'next'})}); setTimeout(fetchNow,300); });
  document.getElementById('prev').addEventListener('click', async ()=>{ await fetch('/api/control',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'previous'})}); setTimeout(fetchNow,300); });
  document.getElementById('stop').addEventListener('click', async ()=>{ await fetch('/api/control',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'stop'})}); setTimeout(fetchNow,300); });
  // device selection handled on the Spotify settings page
  document.getElementById('seek').addEventListener('input', async (e)=>{
    const pct = Number(e.target.value);
    const r = await fetch('/api/nowplaying'); const j = await r.json(); const dur = j.duration_ms||0; const pos = Math.floor(dur * pct/100);
    await fetch('/api/control',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'seek',position_ms:pos})});
    setTimeout(fetchNow,200);
  });
  polling = setInterval(fetchNow, 1000);
  fetchNow();
  async function loadQuickMappings(){
    const r = await fetch('/api/mappings');
    const j = await r.json();
    const select = document.getElementById('mapping-select');
    select.innerHTML = '';
    const maps = j.mappings || [];
    if(maps.length === 0){
      select.appendChild(new Option('No mappings configured', ''));
      document.getElementById('mapping-play').disabled = true;
      return;
    }
    // Add a placeholder option
    select.appendChild(new Option('-- select a mapping --', ''));
    for(const m of maps){
      const label = (m.name && m.name.length>0)? m.name : (m.id || m.card_id);
      select.appendChild(new Option(label, m.card_id));
    }
    document.getElementById('mapping-play').disabled = false;
  }
  loadQuickMappings();
  document.getElementById('mapping-play').addEventListener('click', async ()=>{
    const sel = document.getElementById('mapping-select');
    const card = sel.value;
    if(!card){ return alert('Please select a mapping to play'); }
    const resp = await fetch('/simulate', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({card_id: card})});
    if(!resp.ok){ const j = await resp.json().catch(()=>({})); return alert('Failed to trigger mapping: '+(j.error||resp.status)); }
    // After triggering mapping, try to fetch the mapping options and apply them temporarily
    try{
      const mapsResp = await fetch('/api/mappings');
      const mapsJson = await mapsResp.json();
      const mapping = (mapsJson.mappings||[]).find(x=>x.card_id===card);
      if(mapping){
          // Apply mapping options (shuffle/repeat) temporarily
          await fetch('/api/apply_options', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({shuffle: !!mapping.shuffle, repeat: mapping.repeat || 'off'})});
          // Update UI toggles
          setShuffleButton(!!mapping.shuffle);
          setRepeatButton(mapping.repeat || 'off');
          showToast(`Applied mapping options — shuffle: ${mapping.shuffle? 'on':'off'}, repeat: ${mapping.repeat||'off'}`);
        }
    }catch(e){ /* ignore */ }
  });
  // Volume handling: load current volume and send changes
  const volEl = document.getElementById('volume');
  let volTimeout = null;
  async function loadVolume(){
    try{
      const r = await fetch('/api/volume');
      const j = await r.json();
      if(j && typeof j.volume === 'number'){
        volEl.value = j.volume;
      }
    }catch(e){ /* ignore */ }
  }
  volEl.addEventListener('input', ()=>{
    // debounce rapid changes
    if(volTimeout) clearTimeout(volTimeout);
    volTimeout = setTimeout(async ()=>{
      const v = Number(volEl.value);
      await fetch('/api/control', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({action:'volume', volume: v})});
    }, 150);
  });
  loadVolume();
  // Shuffle / Repeat UI wiring
  const shuffleBtn = document.getElementById('shuffle-btn');
  const repeatBtn = document.getElementById('repeat-btn');
  function setShuffleButton(enabled){
    if(enabled){ shuffleBtn.classList.add('active'); shuffleBtn.dataset.on='1'; }
    else { shuffleBtn.classList.remove('active'); shuffleBtn.dataset.on='0'; }
  }
  // repeatMode can be 'off'|'context'|'track' or a boolean (legacy)
  function setRepeatButton(repeatMode){
    let mode = 'off';
    if(typeof repeatMode === 'string') mode = repeatMode;
    else mode = repeatMode? 'context':'off';
    repeatBtn.dataset.repeatMode = mode;
    if(mode === 'off') repeatBtn.classList.remove('active'); else repeatBtn.classList.add('active');
    repeatBtn.title = `Repeat: ${mode}`;
  }
  async function loadOptions(){
    try{
      const r = await fetch('/api/options'); const j = await r.json(); const o = j.options||{};
      setShuffleButton(!!o.shuffle);
      setRepeatButton(!!o.repeat);
    }catch(e){ /* ignore */ }
  }
  shuffleBtn.addEventListener('click', async ()=>{
    const enabled = shuffleBtn.dataset.on!=='1';
    // persist
    await fetch('/api/options', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({shuffle: enabled})});
    // apply temporarily
    await fetch('/api/apply_options', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({shuffle: enabled})});
    setShuffleButton(enabled);
    showToast(enabled? 'Shuffle enabled':'Shuffle disabled');
  });
  // repeat cycles: off -> context -> track -> off
  repeatBtn.addEventListener('click', async ()=>{
    const current = repeatBtn.dataset.repeatMode || 'off';
    const order = ['off','context','track'];
    const next = order[(order.indexOf(current)+1) % order.length];
    // persist
    await fetch('/api/options', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({repeat: next})});
    // apply temporarily
    await fetch('/api/apply_options', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({repeat: next})});
    setRepeatButton(next);
    showToast(`Repeat set to ${next}`);
  });
  loadOptions();
  // device selection handled on the Spotify settings page; loadDevices removed
  </script>
{% endblock %}
